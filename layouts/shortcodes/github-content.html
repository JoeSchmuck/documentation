<!-- Thank you to Greg Hilston and his excellent article on https://www.greghilston.com/post/hugo-display-dynamic-github-content/ for this shortcode -->
{{ $repo := .Get "repo" }}
{{ $path := .Get "path" }}
{{ $branch := default "main" (.Get "branch") }} <!-- Default to "main" if no branch is provided -->
{{ $url := printf "https://api.github.com/repos/%s/contents/%s" $repo $path }}
{{ $lang := default "plaintext" (.Get "lang") }}
{{ $includeFile := .Get "includeFile" }} <!-- Get the file to include -->

{{ with resources.GetRemote $url }}
  {{ $remoteContent := . }}
  {{ with transform.Unmarshal $remoteContent.Content }}
    {{ $decodedContent := .content | base64Decode }}
    {{ $jsonData := transform.Unmarshal $decodedContent }}

    <!-- Extract the first key dynamically -->
    {{ $firstKey := "" }}
    {{ range $key, $value := $jsonData }}
      {{ $firstKey = $key }}
      {{ break }}
    {{ end }}
    {{ $versionData := index $jsonData $firstKey }}

    <!-- Include File Content -->
    {{ if $includeFile }}
	<details>
	  <summary><small>Understanding App Versioning</small></summary>
      <div>
        {{ $fileContent := readFile $includeFile }}
        {{ $fileContent | markdownify }}
      </div>
	</details>
    {{ end }}
    <!-- Normal Display -->
    <div>
      <ul>
        <li>App Version: {{ $versionData.app_metadata.app_version }}</li>
        <li>Version: {{ $versionData.version }}</li>
		<li>Last Updated: {{ $versionData.last_update }}</li>
      </ul>
      <p>
        <!-- Construct the GitHub blame URL -->
        <a href="https://github.com/{{ $repo }}/blame/{{ $branch }}/{{ $path }}" target="_blank">
          <small>View file changes (blame) on GitHub</small>
        </a>
      </p>
    </div>

    <!-- Expandable Section -->
    <details>
      <summary>App Version File</summary>
      <pre><code>{{ highlight $decodedContent $lang "" }}</code></pre>
    </details>
  {{ end }}
{{ end }}