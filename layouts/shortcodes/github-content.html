<!-- Thank you to Greg Hilston and his excellent article on https://www.greghilston.com/post/hugo-display-dynamic-github-content/ for this shortcode -->
{{ $repo := .Get "repo" }}
{{ $path := .Get "path" }}
{{ $branch := default "master" (.Get "branch") }}
{{ $url := printf "https://api.github.com/repos/%s/contents/%s" $repo $path }}
{{ $lang := default "plaintext" (.Get "lang") }}
{{ $includeFile := .Get "includeFile" }}
{{ $title := .Get "title" }}

{{ with resources.GetRemote $url }}
  {{ $remoteContent := . }}
  {{ with transform.Unmarshal $remoteContent.Content }}
    {{ $decodedContent := .content | base64Decode }}
    {{ $jsonData := transform.Unmarshal $decodedContent }}

    <!-- Extract the first key dynamically -->
    {{ $firstKey := "" }}
    {{ range $key, $value := $jsonData }}
      {{ $firstKey = $key }}
      {{ break }}
    {{ end }}
    {{ $versionData := index $jsonData $firstKey }}

    <!-- Extract specific values from the JSON -->
    {{ $icon := $versionData.app_metadata.icon }}
    {{ $name := $versionData.app_metadata.name }} <!-- Use app_metadata.name -->
    {{ $descr := $versionData.app_metadata.description }}

    <!-- Fetch Telemetry Data -->
    {{ $telemetryURL := "https://telemetry.sys.truenas.net/apps/truenas-apps-stats.json" }}
    {{ $telemetryData := resources.GetRemote $telemetryURL | transform.Unmarshal }}

    <!-- Check if the app is actively deployed with more than 5000 instances -->
    {{ $deploymentCount := 0 }}
    {{ if $telemetryData }}
      {{ range $category, $apps := $telemetryData }}
        {{ $appCount := index $apps $name }}
        {{ if $appCount }}
          {{ $deploymentCount = $appCount }}
        {{ end }}
      {{ end }}
    {{ end }}

	<!-- Text Card Layouts -->
	<div class="apps-docs-sections">
	<!-- First Card -->
	<div class="section-box">
		<div class="box-image">
		<img class="app-card-img" src="{{ $icon }}" aria-label="{{ $name }} Logo">
		</div>
		<div class="section-tab-content ixprods">
		<b style="justify-content:center;font-size:1.5rem;font-weight:600;">{{ $versionData.app_metadata.title }}</b><br>
		<a class="truenas-appbutton" href="https://www.truenas.com/docs/truenasapps/">Get Started with Apps!</a><br>
		<small>App Version: <b>{{ $versionData.app_metadata.app_version }}</b>
		{{ with $versionData.app_metadata.home }}
			{{ if strings.HasPrefix . "https://github.com" }}
			(<a href="{{ . }}/releases/" target="_blank">Releases</a>)
			{{ end }}
		{{ end }}
		<br>
		Version: <b>{{ $versionData.version }}</b> (<a href="https://github.com/{{ $repo }}/blame/{{ $branch }}/{{ $path }}" target="_blank">Updated {{ substr $versionData.last_update 0 10 }}</a>)<br>
		{{ with $versionData.app_metadata.keywords }}
		  Keywords: {{ delimit . ", " }}<br>
		{{ end }}
		Train: {{ $versionData.app_metadata.train }}<br>
	    Home Page: <a href="{{ $versionData.app_metadata.home }}" target="_blank">{{ $versionData.app_metadata.home }}</a><br>
		</small>
		</div>
	</div>
	
	<!-- Second Card -->
	<div class="section-box">
	<div class="box-image">
	<!-- Add Inline Icon and Placeholder Text for active use callouts -->
		{{ if gt $deploymentCount 0 }}
		<div class="popular-app">
			{{ if gt $deploymentCount 10000 }}
			<img src="/images/AdobeStock_606441794.png" alt="10,000 active deployments icon" style="width: 20px; height: 20px; vertical-align: middle;">
			<span style="font-weight: bold; color: #0095d5;">Actively used on over 10,000 TrueNAS systems!</span><br>
			{{ else if gt $deploymentCount 5000 }}
			<img src="/images/AdobeStock_653744533.png" alt="5,000 active deployments icon" style="width: 20px; height: 20px; vertical-align: middle;">
			<span style="font-weight: bold; color: #0095d5;">Actively used on over 5,000 TrueNAS systems!</span><br>
			{{ else if gt $deploymentCount 1000 }}
			<img src="/images/AdobeStock_709806220.png" alt="1,000 active deployments icon" style="width: 20px; height: 20px; vertical-align: middle;">
			<span style="font-weight: bold; color: #0095d5;">Actively used on over 1,000 TrueNAS systems!</span><br>
			{{ else if gt $deploymentCount 100 }}
			<img src="/images/AdobeStock_1240018133.png" alt="100 active deployments icon" style="width: 2em; vertical-align: middle;">
			<span style="font-weight: bold; color: #0095d5;">Actively used on over 100 TrueNAS systems!</span><br>
			{{ end }}
		</div>
		{{ end }}
		<b>{{ $versionData.app_metadata.title }} Details</b><br>
		{{ $descr }}<br>
	<div class="app-details">
	  <!-- Context Section -->
	  {{ if $versionData.app_metadata.run_as_context }}
		<p><small><b>Run as Context</b></small>
		<ul style="list-style-type:none;">
			{{ range $run_as_context := $versionData.app_metadata.run_as_context }}
			<li>
				<small>
				{{ $run_as_context.description }}<br>
				&nbsp;&nbsp;<b>Group:</b> {{ $run_as_context.gid }} / {{ $run_as_context.group_name }}<br>
				&nbsp;&nbsp;<b>User:</b> {{ $run_as_context.uid }} / {{ $run_as_context.user_name }}
				</small>
			</li>
			{{ end }}
		</ul>
		</p>
		{{ end }}
	</div>
	</div>
	</div>
	</div>

{{ if $includeFile }}
	<details>
		<summary><small>Understanding App Versioning</small></summary>
			<div>
				{{ $fileContent := readFile $includeFile }}
				{{ $fileContent | markdownify }}
			</div>
	</details>
{{ end }}

<!-- Screenshots Section: displays only when app versions file has screenshot URLs added -->
{{ if $versionData.app_metadata.screenshots }}
  <br>
  <div class="screenshots-section">
    <b>Screenshots</b>
    <div class="screenshots-thumbnails">
		{{ range $index, $screenshot := $versionData.app_metadata.screenshots }}
		<img class="screenshot-thumbnail" src="{{ $screenshot }}" alt="Screenshot {{ add $index 1 }}" onclick="openLightbox('{{ $screenshot }}')">
		{{ end }}
	</div>
  </div>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <span class="lightbox-close">&times;</span>
    <img id="lightbox-image" class="lightbox-content" src="" alt="Full Screenshot">
    <div class="lightbox-controls">
      <button id="prev-button" onclick="prevImage(event)">&#10094;</button>
      <button id="next-button" onclick="nextImage(event)">&#10095;</button>
    </div>
  </div>
{{ end }}
	
<!-- Security Capabilities Section -->
{{ if $versionData.app_metadata.capabilities }}
	{{ if gt (len $versionData.app_metadata.capabilities) 0 }}
	<br>
	<details>
		<summary>Security Capabilities</summary>
		<ul>
			{{ range $capability := $versionData.app_metadata.capabilities }}
			<li>
				{{ $capability.description }}
			</li>
			{{ end }}
		</ul>
	</details>
	{{ end }}
{{ end }}
<!-- Expandable Section -->
<br>
<details>
  <summary>App Metadata (Raw File)</summary>
  <pre><code>{{ highlight $decodedContent $lang "" }}</code></pre>
</details>
<br>
<hr>
  {{ end }}
{{ end }}