<!-- Thank you to Greg Hilston and his excellent article on https://www.greghilston.com/post/hugo-display-dynamic-github-content/ for this shortcode -->
{{ $repo := .Get "repo" }}
{{ $path := .Get "path" }}
{{ $branch := default "master" (.Get "branch") }} <!-- Default to "master" if no branch is provided -->
{{ $url := printf "https://api.github.com/repos/%s/contents/%s" $repo $path }}
{{ $lang := default "plaintext" (.Get "lang") }}
{{ $includeFile := .Get "includeFile" }} <!-- Get the file to include -->
{{ $title := .Get "title" }} <!-- Title for the card -->

{{ with resources.GetRemote $url }}
  {{ $remoteContent := . }}
  {{ with transform.Unmarshal $remoteContent.Content }}
    {{ $decodedContent := .content | base64Decode }}
    {{ $jsonData := transform.Unmarshal $decodedContent }}

    <!-- Extract the first key dynamically -->
    {{ $firstKey := "" }}
    {{ range $key, $value := $jsonData }}
      {{ $firstKey = $key }}
      {{ break }}
    {{ end }}
    {{ $versionData := index $jsonData $firstKey }}

    <!-- Extract specific values from the JSON -->
    {{ $icon := $versionData.app_metadata.icon }}
    {{ $name := $versionData.app_metadata.title }}
	{{ $descr := $versionData.app_metadata.description }}

	<!-- Text Card Layouts -->
	<div class="apps-docs-sections">
	<!-- First Card -->
	<div class="section-box">
		<div class="box-image">
		<img class="app-card-img" src="{{ $icon }}" aria-label="{{ $name }} Logo">
		</div>
		<div class="section-tab-content ixprods">
		<b style="justify-content:center;font-size:1.5rem;font-weight:600;">{{ $name }}</b><br>
		<a class="truenas-appbutton" href="https://www.truenas.com/docs/truenasapps/">Get Started with Apps!</a><br>
		<small>App Version: {{ $versionData.app_metadata.app_version }}<br>
		Version: {{ $versionData.version }}<br>
		<a href="https://github.com/{{ $repo }}/blame/{{ $branch }}/{{ $path }}" target="_blank">Last Updated: {{ $versionData.last_update }}</a><br>
		Keywords: {{ delimit $versionData.app_metadata.keywords ", " }}<br>
		Train: {{ $versionData.app_metadata.train }}<br>
	    Home Page: <a href="{{ $versionData.app_metadata.home }}" target="_blank">{{ $versionData.app_metadata.home }}</a><br>
		</small>
		</div>
	</div>
	
	<!-- Second Card -->
	<div class="section-box">
	<div class="box-image">
		<b>{{ $name }} Details</b><br>
		{{ $descr }}<br>
	</div>
	<div class="ixprods">
	  <!-- Context Section -->
	  {{ if $versionData.app_metadata.run_as_context }}
		<p><small><b>User & Groups Context</b></small></p>
		<ul style="list-style-type:none;">
			{{ range $run_as_context := $versionData.app_metadata.run_as_context }}
			<li>
				<small>
				{{ $run_as_context.description }}<br>
				&nbsp;&nbsp;<b>Group:</b> {{ $run_as_context.gid }} / {{ $run_as_context.group_name }}<br>
				&nbsp;&nbsp;<b>User:</b> {{ $run_as_context.uid }} / {{ $run_as_context.user_name }}
				</small>
			</li>
			{{ end }}
		</ul>
		{{ end }}
	</div>
	</div>
	</div>

{{ if $includeFile }}
	<details>
		<summary><small>Understanding App Versioning</small></summary>
			<div>
				{{ $fileContent := readFile $includeFile }}
				{{ $fileContent | markdownify }}
			</div>
	</details>
{{ end }}

<!-- Screenshots Section: displays only when app versions file has screenshot URLs added -->
{{ if $versionData.app_metadata.screenshots }}
  <br>
  <div class="screenshots-section">
    <b>Screenshots</b>
    <div class="screenshots-thumbnails">
		{{ range $index, $screenshot := $versionData.app_metadata.screenshots }}
		<img class="screenshot-thumbnail" src="{{ $screenshot }}" alt="Screenshot {{ add $index 1 }}" onclick="openLightbox('{{ $screenshot }}')">
		{{ end }}
	</div>
  </div>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <span class="lightbox-close">&times;</span>
    <img id="lightbox-image" class="lightbox-content" src="" alt="Full Screenshot">
    <div class="lightbox-controls">
      <button id="prev-button" onclick="prevImage(event)">&#10094;</button>
      <button id="next-button" onclick="nextImage(event)">&#10095;</button>
    </div>
  </div>
{{ end }}
	
<!-- Security Capabilities Section -->
{{ if $versionData.app_metadata.capabilities }}
	{{ if gt (len $versionData.app_metadata.capabilities) 0 }}
	<br>
	<details>
		<summary>Security Capabilities</summary>
		<ul>
			{{ range $capability := $versionData.app_metadata.capabilities }}
			<li>
				{{ $capability.description }}
			</li>
			{{ end }}
		</ul>
	</details>
	{{ end }}
{{ end }}
<!-- Expandable Section -->
<br>
<details>
  <summary>App Metadata (Raw File)</summary>
  <pre><code>{{ highlight $decodedContent $lang "" }}</code></pre>
</details>
<br>
<hr>
  {{ end }}
{{ end }}